name: Deploy to Lightsail

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build
        run: npm run build
        env:
          # ビルド時にNext.jsがDB接続をチェックする場合のダミーなどが必要なら設定
          DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy" 

      - name: Prepare standalone build
        run: |
          # スタンドアロンビルドに必要な静的ファイルをコピー
          cp -r public .next/standalone/public
          cp -r .next/static .next/standalone/.next/static
          
          # マイグレーションに必要なファイルも同梱（または別途転送）
          # ここではスタンドアロンフォルダにまとめてしまう
          cp -r prisma .next/standalone/prisma

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: .next/standalone
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./dist

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: "just-a-placeholder-so-we-dont-get-errors"
          if_key_exists: replace

      - name: Adding Known Hosts
        run: ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy with rsync
        run: |
          # rsyncで転送
          # --delete は危険なので今回はつけない（.envなどが消えるのを防ぐため）
          # 転送先ディレクトリ: /home/guchi/app/asset-manager
          rsync -avz -e "ssh -p ${{ secrets.VPS_PORT }}" ./dist/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/guchi/app/asset-manager

      - name: Post-deployment tasks
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /home/guchi/app/asset-manager
            
            # .envを強制的に再作成（Secretsから）
            echo "Updating .env file..."
            rm -f .env
            echo "DATABASE_URL=\"${{ secrets.DATABASE_URL }}\"" > .env
            echo "PORT=3102" >> .env

            # DBマイグレーション実行
            # Prisma関連は node_modules/.bin/prisma がないので npx で実行したいが
            # standaloneには package.json はあるが npm install はしてない
            # ただし serverExternalPackages 設定により prisma 本体はコピーされているはず...
            # 安全のため、最小限の依存関係として prisma だけは必要かもしれない
            # あるいは npx prisma を使うために一時的にインストールするか。
            
            # スタンドアロンビルドの場合、グローバルなprismaなどを使うか、
            # schema.prismaがあるので npx prisma migrate deploy が通る環境が必要。
            # サーバー側にはNodeが入っているので npx は使える。
            
            echo "Running migrations..."
            # 専用の .env をロードさせる必要があるかも
            npx prisma migrate deploy

            # PM2で再起動
            echo "Restarting PM2..."
            pm2 restart asset-manager || pm2 start server.js --name asset-manager
