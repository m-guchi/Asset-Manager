name: Deploy to Lightsail

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Clean previous build artifacts
        run: rm -rf .next

      - name: Build
        run: npm run build
        env:
            # 本番用接続情報をSecretsから注入
            DATABASE_URL: ${{ secrets.DATABASE_URL }} 
            NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
            NEXT_PUBLIC_NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
            AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
            AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}

      - name: Create archive
        run: |
          # 必要なファイルをすべてまとめてtar.gzにする
          tar -czf deploy.tar.gz package.json package-lock.json public .next prisma next.config.ts scripts lib tsconfig.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: deploy.tar.gz
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: "just-a-placeholder-so-we-dont-get-errors"
          if_key_exists: replace

      - name: Adding Known Hosts
        run: ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy archive
        run: |
            # deploy.tar.gz をサーバーに転送
            scp -P ${{ secrets.VPS_PORT }} deploy.tar.gz ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/guchi/app/asset-manager/deploy.tar.gz

      - name: Post-deployment tasks
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /home/guchi/app/asset-manager
            
            # 古いファイルをクリーンアップ（設定ファイルやnode_modulesは残す）
            echo "Cleaning up old files..."
            rm -rf .next public package.json package-lock.json prisma next.config.ts scripts lib tsconfig.json

            # アーカイブを展開
            echo "Extracting archive..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            # .envを強制的に再作成
            echo "Updating .env file..."
            rm -f .env
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> .env
            echo "NEXT_PUBLIC_NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> .env
            echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env
            echo "AUTH_GOOGLE_ID=${{ secrets.AUTH_GOOGLE_ID }}" >> .env
            echo "AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}" >> .env
            echo "AUTH_TRUST_HOST=true" >> .env
            echo "PORT=3102" >> .env

            # 依存関係のインストール
            echo "Installing production dependencies..."
            npm install --omit=dev --no-audit --prefer-offline

            # DBマイグレーション実行
            echo "Updating database schema..."
            npx prisma generate
            npx prisma db push --accept-data-loss

            # DB接続・データ取得テスト
            echo "Testing production DB data retrieval..."
            # npx tsx を使って TypeScript 実行
            npx -y tsx scripts/test-db-connection.ts

            # PM2で再起動
            echo "Restarting PM2..."
            pm2 delete asset-manager || true
            
            export PORT=3102
            export NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
            export NEXT_PUBLIC_NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
            export AUTH_URL="${{ secrets.NEXTAUTH_URL }}"
            export NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
            export AUTH_GOOGLE_ID="${{ secrets.AUTH_GOOGLE_ID }}"
            export AUTH_GOOGLE_SECRET="${{ secrets.AUTH_GOOGLE_SECRET }}"
            export AUTH_TRUST_HOST="true"
            export TRUST_PROXY="1"
            
            echo "Starting PM2 with NEXTAUTH_URL: $NEXTAUTH_URL"
            pm2 start npm --name asset-manager -- start -- -p 3102 -H 0.0.0.0

            # ヘルスチェック（起動確認）
            echo "Waiting for app to start..."
            sleep 20
            curl -f http://localhost:3102 || (echo "Health check failed!" && exit 1)
            echo "Deployment successful and app is running."
