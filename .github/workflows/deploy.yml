name: Deploy to Lightsail

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build
        run: npm run build
        env:
          DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy" 

      - name: Prepare production artifacts
        run: |
          mkdir dist
          cp package.json package-lock.json dist/
          cp -r public dist/
          cp -r .next dist/
          cp -r prisma dist/
          cp next.config.ts dist/ 
          # next.config.tsが必要な場合があるため含める（JSの場合はnext.config.js）

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./dist

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: "just-a-placeholder-so-we-dont-get-errors"
          if_key_exists: replace

      - name: Adding Known Hosts
        run: ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy with rsync
        run: |
          # node_modulesは転送せず、サーバー側でインストールする
          # --delete オプションを追加して、ローカルに無い余計なファイルをサーバーから削除する（クリーンアップ）
          rsync -avz --delete -e "ssh -p ${{ secrets.VPS_PORT }}" ./dist/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/guchi/app/asset-manager

      - name: Post-deployment tasks
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /home/guchi/app/asset-manager
            
            # .envを強制的に再作成（Secretsから）
            echo "Updating .env file..."
            rm -f .env
            echo "DATABASE_URL=\"${{ secrets.DATABASE_URL }}\"" > .env
            echo "PORT=3102" >> .env

            # 依存関係のインストール（本番用のみ）
            echo "Installing production dependencies..."
            # npm ciだとpackage-lock.jsonとの不整合で失敗する場合があるため、安全にinstallを使う
            # --productionをつけることでdevDependencies（tailwindcssなど）をスキップ
            npm install --production --no-audit --prefer-offline

            # DBマイグレーション実行
            echo "Running migrations..."
            # npxはローカルインストールされたパッケージを使う
            npx prisma migrate deploy

            # PM2で再起動（npm startを使用）
            echo "Restarting PM2..."
            pm2 delete asset-manager || true
            PORT=3102 pm2 start npm --name asset-manager -- start
