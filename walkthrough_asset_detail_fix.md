# Walkthrough: 資産詳細画面における子・孫アセットのフィルタ・集計修正

親アセットの詳細画面において、子アセットの取引フィルタが正常に動作していなかった問題、および孫アセット以降のデータが集計に含まれていなかった問題を修正しました。

## 修正内容

### 1. 取引フィルタ機能の修正 (`app/assets/[id]/page.tsx`)
- **不具合の原因**: 取引履歴のフィルタリング時に「カテゴリ名」と「カテゴリID」を比較していたため、常に不一致となりフィルタが効かない状態でした。
- **修正後**: 取引データの `categoryId` を使用してフィルタリングを行うように修正し、正しく絞り込みができるようになりました。
- **拡張**: フィルタの選択肢に「孫アセット」も含めるようにし、深い階層のアセットによる絞り込みも可能にしました。

### 2. 再帰的なデータ集計の導入 (`app/actions/categories.ts`)
- **履歴と取引の網羅**: これまでは直下の子アセットのみを集計対象としていましたが、再帰的に全ての末端アセット（孫、ひ孫...）を探索して、それら全ての取引履歴と資産推移を取得するように拡張しました。
- **チャート表示の改善**: 資産推移チャートにおいて、直下の子アセットごとの積上げ表示を維持しつつ、各子アセットの数値にはその配下にある孫アセット以降の合計値が合算されるように計算ロジックを修正しました。
- **評価額の正確性**: 親アセットの「評価額」が、自身の評価額 ＋ 全ての子・孫アセットの評価額の合計値として正しく算出されるようになりました。

## 再現・確認手順

1. **フィルタ機能の確認**:
   - 複数の「子アセット」を持つ「親アセット」のページを開きます。
   - 「取引・評価履歴」セクションのドロップダウンから特定のアセットを選択します。
   - 選択したアセットの履歴のみが表示されることを確認します。
2. **孫アセットの確認**:
   - 孫アセットに対して取引（入出金や評価更新）を登録します。
   - その「親」および「祖父（親の親）」のアセットページを開き、取引履歴に孫アセットの記録が含まれていること、および資産推移チャートに反映されていることを確認してください。
